# ドット絵エディター 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
ドット絵エディター (Pixel Art Editor)

### 1.2 目的
12×12ピクセルのドット絵をブラウザ上で作成し、二次元配列形式でデータを出力するツール

### 1.3 対象ユーザー
- ゲーム開発者
- ピクセルアートクリエイター
- インディーゲーム制作者

### 1.4 システム概要
ブラウザ上で動作する単一ページアプリケーション（SPA）として、12×12のキャンバスにDB32パレットを使用してドット絵を描画し、JavaScript配列形式でデータを出力する。

---

## 2. 機能要件

### 2.1 キャンバス機能

#### 2.1.1 基本仕様
| 項目 | 仕様 |
|------|------|
| サイズ | 固定12×12ピクセル |
| 表示倍率 | 30倍以上（360×360px以上で表示） |
| 初期状態 | 全ピクセル透明（パレット番号0） |
| グリッド線 | 1px幅、色:#cccccc、表示ON/OFF切替可能 |
| 背景 | チェッカーボードパターン（透過確認用） |

#### 2.1.2 チェッカーボード仕様
- パターン: 明暗2色の市松模様
- 明色: #ffffff
- 暗色: #e0e0e0
- セルサイズ: 各ピクセル1マスごと

### 2.2 カラーパレット機能

#### 2.2.1 パレット仕様
| 項目 | 仕様 |
|------|------|
| 色数 | DB32パレット32色 + 透明色1色 = 計33色 |
| 配置順序 | パレット番号0-32の順 |
| グループ分け | 色系統ごとにセクション分割表示 |

#### 2.2.2 DB32パレット定義
\`\`\`javascript
const PALETTE = {
  0: 'transparent',      // 透明
  1: '#000000',          // 黒
  2: '#222034',          // 濃い紫黒
  3: '#45283c',          // 暗い紫
  4: '#663931',          // 暗い茶色
  5: '#8f563b',          // 茶色
  6: '#df7126',          // オレンジ茶
  7: '#d9a066',          // ベージュ
  8: '#eec39a',          // 明るいベージュ
  9: '#fbf236',          // 鮮やかな黄色
  10: '#99e550',         // 黄緑
  11: '#6abe30',         // 緑
  12: '#37946e',         // 深緑
  13: '#4b692f',         // 暗いオリーブ
  14: '#524b24',         // オリーブ茶
  15: '#323c39',         // 暗い灰緑
  16: '#3f3f74',         // 暗い青紫
  17: '#306082',         // 暗い青
  18: '#5b6ee1',         // 青
  19: '#639bff',         // 明るい青
  20: '#5fcde4',         // シアン
  21: '#cbdbfc',         // 薄い青
  22: '#ffffff',         // 白
  23: '#9badb7',         // 明るい灰色
  24: '#847e87',         // 中間灰色
  25: '#696a6a',         // 暗い灰色
  26: '#595652',         // 暗い茶灰色
  27: '#76428a',         // 紫
  28: '#ac3232',         // 暗い赤
  29: '#d95763',         // 赤
  30: '#d77bba',         // ピンク
  31: '#8f974a',         // 黄土色
  32: '#8a6f30'          // 暗い金色
};
\`\`\`

#### 2.2.3 パレット表示グループ
| グループ名 | パレット番号 |
|-----------|-------------|
| 透明 | 0 |
| モノクロ | 1, 22, 23, 24, 25, 26 |
| 茶・肌 | 4, 5, 6, 7, 8, 32 |
| 緑 | 13, 14, 10, 11, 12 |
| 青 | 15, 16, 17, 18, 19, 20, 21 |
| 紫 | 2, 3, 27 |
| 赤・ピンク | 28, 29, 30 |
| 黄 | 9, 31 |

#### 2.2.4 パレットUI仕様
- 各色: 28×28px以上のクリック可能なボックス
- 選択中の色: 3px幅の枠線で強調表示（色:#ffaa00）
- 透明色の表示: チェッカーボード背景
- デフォルト選択色: パレット番号1（黒）

### 2.3 描画機能

#### 2.3.1 ペンツール（必須）
| 項目 | 仕様 |
|------|------|
| 動作 | クリックしたピクセルを選択色で塗る |
| ドラッグ | マウスドラッグ中は通過した全ピクセルを塗る |
| 操作 | 左クリック |

#### 2.3.2 消しゴムツール（必須）
| 項目 | 仕様 |
|------|------|
| 動作 | クリックしたピクセルを透明（0）にする |
| ドラッグ | マウスドラッグ中は通過した全ピクセルを透明化 |
| 切替 | ツールボタンまたはキーボードショートカット |

#### 2.3.3 塗りつぶしツール（推奨）
| 項目 | 仕様 |
|------|------|
| 動作 | クリックしたピクセルと同色で隣接する領域を一括変更 |
| アルゴリズム | Flood Fill（4方向または8方向） |
| 対象 | 同一パレット番号のピクセル |

#### 2.3.4 スポイトツール（推奨）
| 項目 | 仕様 |
|------|------|
| 動作 | クリックしたピクセルの色を取得し、選択色にする |
| 操作 | 右クリックまたは専用ボタン |

#### 2.3.5 全消去（必須）
| 項目 | 仕様 |
|------|------|
| 動作 | キャンバス全体を透明（0）にリセット |
| 確認 | なし（操作即時反映） |

### 2.4 プレビュー機能

#### 2.4.1 プレビュー仕様（必須）
| 項目 | 仕様 |
|------|------|
| サイズ | 120×120px |
| 背景 | チェッカーボード |
| 更新 | 描画操作と同時にリアルタイム更新 |
| 配置 | 編集キャンバス直下 |

#### 2.4.2 拡張プレビュー（将来検討）
- 背景色切り替えや倍率変更などは今後の拡張項目として管理

### 2.5 出力機能
.1 データ出力形式
\`\`\`javascript
// 形式: JavaScript二次元配列（12行×12列）
// 各要素: パレット番号（0-32の整数）

// 出力例（改行あり・推奨）
[
  [ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ],
  [ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ],
  [ 0, 0,28,28,28, 0, 0,28,28,28, 0, 0 ],
  [ 0,28,28,28,28,28,28,28,28,28,28, 0 ],
  [ 0,28,28,28,28,28,28,28,28,28,28, 0 ],
  [ 0,28,28,28,28,28,28,28,28,28,28, 0 ],
  [ 0,28,28,28,28,28,28,28,28,28,28, 0 ],
  [ 0, 0,28,28,28,28,28,28,28,28, 0, 0 ],
  [ 0, 0,28,28,28,28,28,28,28,28, 0, 0 ],
  [ 0, 0, 0,28,28,28,28,28,28, 0, 0, 0 ],
  [ 0, 0, 0, 0,28,28,28,28, 0, 0, 0, 0 ],
  [ 0, 0, 0, 0, 0,28,28, 0, 0, 0, 0, 0 ]
]

// 出力例（改行なし・コンパクト）
[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,28,28,28,0,0,28,28,28,0,0],[0,28,28,28,28,28,28,28,28,28,28,0],[0,28,28,28,28,28,28,28,28,28,28,0],[0,28,28,28,28,28,28,28,28,28,28,0],[0,28,28,28,28,28,28,28,28,28,28,0],[0,0,28,28,28,28,28,28,28,28,0,0],[0,0,28,28,28,28,28,28,28,28,0,0],[0,0,0,28,28,28,28,28,28,0,0,0],[0,0,0,0,28,28,28,28,0,0,0,0],[0,0,0,0,0,28,28,0,0,0,0,0]]

\`\`\`

#### 2.5.2 出力UI仕様
| 項目 | 仕様 |
|------|------|
| 表示場所 | テキストエリア（読み取り専用） |
| サイズ | 幅100%、高さ150px以上 |
| フォント | 等幅フォント（monospace） |
| コピーボタン | ワンクリックでクリップボードにコピー |
| フォーマット選択 | 改行あり/なしの切替（推奨） |

#### 2.5.3 コピー機能
- クリップボードAPIを使用: \`navigator.clipboard.writeText()\`
- 成功時: 「コピーしました」と一時表示（2秒間）
- 失敗時: エラーメッセージを表示して再操作を促す

### 2.6 入力機能（データ読込）

#### 2.6.1 配列読込機能（必須）
| 項目 | 仕様 |
|------|------|
| 入力方法 | テキストエリアにペーストして「読込」ボタン押下 |
| 対応形式 | JavaScript配列リテラル |
| バリデーション | サイズ・数値範囲チェック |

#### 2.6.2 バリデーションルール
| 検証項目 | 合格条件 | エラーメッセージ例 |
|---------|---------|------------------|
| 外側配列長 | 12要素 | 「行数が12ではありません（現在: X行）」 |
| 内側配列長 | 各12要素 | 「Y行目の列数が12ではありません（現在: X列）」 |
| 数値範囲 | 0-32の整数 | 「Y行X列の値が範囲外です（値: Z）」 |
| データ型 | 数値 | 「Y行X列が数値ではありません」 |
| JSON形式 | 正しいJSON | 「配列の形式が正しくありません」 |

#### 2.6.3 読込後の動作
1. バリデーション通過後、キャンバスに反映
2. プレビューも同時更新
3. 出力エリアにも同じデータを表示
4. 成功メッセージ表示（2秒間）

---

## 3. UI/UX要件

### 3.1 画面レイアウト

\`\`\`
┌─────────────────────────────────────────────────┐
│         ドット絵エディター                       │
│         12×12 DB32 Palette                      │
├──────────────────────┬──────────────────────────┤
│                      │                          │
│   キャンバスエリア    │   パレットエリア          │
│                      │                          │
│   ┌────────────────┐ │   [透明]                 │
│   │                │ │   モノクロ: ■□□□□□    │
│   │  12×12 Canvas  │ │   茶・肌: ■■■■■■      │
│   │  (360×360px)   │ │   緑: ■■■■■           │
│   │                │ │   青: ■■■■■■■       │
│   │                │ │   紫: ■■■              │
│   └────────────────┘ │   赤: ■■■              │
│                      │   黄: ■■                │
│   [グリッド ON/OFF]  │                          │
│                      │   ツールバー              │
├──────────────────────┤   [ペン] [消しゴム]       │
│                      │   [塗りつぶし] [スポイト]  │
│   プレビューエリア    │   [全消去]               │
│   実寸: 12×12px      │                          │
│   拡大: 120×120px     │                          │
│                      │                          │
│                      │                          │
│                      │                          │
│                      │                          │
│                      │                          │
└──────────────────────┴──────────────────────────┘
┌─────────────────────────────────────────────────┐
│   出力データエリア                               │
│   ┌───────────────────────────────────────────┐ │
│   │ [[0,1,1,0,...],[1,23,23,1,...],...]       │ │
│   │                                           │ │
│   └───────────────────────────────────────────┘ │
│   [コピー] [改行あり/なし]                      │
├─────────────────────────────────────────────────┤
│   入力データエリア                               │
│   ┌───────────────────────────────────────────┐ │
│   │ 配列をここにペースト                       │ │
│   └───────────────────────────────────────────┘ │
│   [読込]                                        │
└─────────────────────────────────────────────────┘
\`\`\`

### 3.2 操作方法

#### 3.2.1 マウス操作
| 操作 | 動作 |
|------|------|
| 左クリック | 選択ツールで描画/操作 |
| 左ドラッグ | 連続描画 |
| 右クリック | スポイトツール起動（推奨） |

#### 3.2.2 キーボードショートカット
| キー | 動作 |
|------|------|
| `B` | ペンツール選択 |
| `E` | 消しゴムツール選択 |
| `F` | 塗りつぶしツール選択 |
| `I` | スポイトツール選択 |
| `Ctrl + D` | 全消去（即時反映） |

### 3.3 レスポンシブ対応
### 3.3 レスポンシブ対応

#### 3.3.1 対応画面サイズ
| デバイス | 対応状況 | 最小幅 |
|---------|---------|--------|
| デスクトップ | 完全対応 | 1024px |
| タブレット | 部分対応 | 768px |
| モバイル | 非推奨 | - |

#### 3.3.2 タブレット時のレイアウト
- パレットをキャンバス下部に配置
- 2カラム → 1カラム縦配置
- ツールボタンを大きく（タップしやすく）

### 3.4 視覚フィードバック

#### 3.4.1 ホバー効果
- パレット色: ホバー時に明るく表示
- ツールボタン: ホバー時に背景色変更
- キャンバスピクセル: ホバー時に薄い枠線表示

#### 3.4.2 選択状態の表示
- 選択中のツール: 背景色を強調（#007bff等）
- 選択中の色: 太枠で囲む（3px、#ffaa00）

#### 3.4.3 一時メッセージ表示
| 動作 | メッセージ | 表示時間 |
|------|----------|---------|
| コピー成功 | 「コピーしました！」 | 2秒 |
| 読込成功 | 「データを読み込みました」 | 2秒 |
| 全消去実行 | 「キャンバスをクリアしました」 | 2秒 |

---

## 4. 非機能要件

### 4.1 パフォーマンス要件

| 項目 | 要件 |
|------|------|
| 初回ロード時間 | 2秒以内 |
| 描画応答時間 | 16ms以内（60fps維持） |
| ツール切替 | 即座（100ms以内） |
| データ出力生成 | 100ms以内 |
| メモリ使用量 | 50MB以内 |

### 4.2 互換性要件

#### 4.2.1 ブラウザ対応
| ブラウザ | 最小バージョン | 対応状況 |
|---------|--------------|---------|
| Google Chrome | 90以降 | 完全対応 |
| Mozilla Firefox | 88以降 | 完全対応 |
| Safari | 14以降 | 完全対応 |
| Microsoft Edge | 90以降 | 完全対応 |
| Internet Explorer | - | 非対応 |

#### 4.2.2 必須Web API
- Canvas API
- Clipboard API
- JSON API

### 4.3 可用性要件

| 項目 | 要件 |
|------|------|
| 稼働率 | N/A（静的サイト） |
| エラー復帰 | エラー時は警告表示のみ、アプリは継続動作 |

### 4.4 セキュリティ要件

| 項目 | 対応 |
|------|------|
| XSS対策 | ユーザー入力はすべてサニタイズ |
| データ保存 | ローカルのみ（サーバー送信なし） |
| HTTPS | 推奨（必須ではない） |

### 4.5 保守性要件

| 項目 | 要件 |
|------|------|
| コード品質 | ESLint準拠 |
| コメント | 主要関数に説明コメント必須 |
| 関数サイズ | 1関数50行以内を推奨 |
| テスト | 主要機能の単体テスト実施 |

---

## 5. 技術仕様

### 5.1 使用技術

| 分類 | 技術 | バージョン |
|------|------|----------|
| HTML | HTML5 | - |
| CSS | CSS3 | - |
| JavaScript | ES6+ | - |
| フレームワーク | なし（Vanilla JS）または軽量ライブラリ | - |
| ビルドツール | 不要（任意） | - |

### 5.2 Canvas設定

\`\`\`javascript
// Canvas要素作成
const canvas = document.createElement('canvas');
canvas.width = 12;
canvas.height = 12;

// Context取得（重要な設定）
const ctx = canvas.getContext('2d', {
  alpha: true,                    // 透過サポート
  willReadFrequently: true        // getImageData頻繁使用
});

// アンチエイリアス無効化（ピクセルパーフェクト）
ctx.imageSmoothingEnabled = false;
ctx.webkitImageSmoothingEnabled = false;
ctx.mozImageSmoothingEnabled = false;
ctx.msImageSmoothingEnabled = false;

// 表示用Canvas（拡大表示）
const displayCanvas = document.getElementById('display');
displayCanvas.width = 360;  // 12 × 30
displayCanvas.height = 360;
const displayCtx = displayCanvas.getContext('2d');
displayCtx.imageSmoothingEnabled = false;
\`\`\`

### 5.3 データ構造

#### 5.3.1 内部データ構造
\`\`\`javascript
// キャンバスデータ（12×12の二次元配列）
let canvasData = Array(12).fill(null).map(() => Array(12).fill(0));

// 例: canvasData[y][x] = paletteIndex

// 選択状態
let selectedColor = 1;  // デフォルトは黒
let selectedTool = 'pen';  // 'pen', 'eraser', 'fill', 'eyedropper'
\`\`\`

#### 5.3.2 パレットデータ
\`\`\`javascript
const PALETTE = [
  { index: 0, color: 'transparent', name: '透明' },
  { index: 1, color: '#000000', name: '黒' },
  { index: 2, color: '#222034', name: '濃い紫黒' },
  // ... 省略 ...
  { index: 32, color: '#8a6f30', name: '暗い金色' }
];
\`\`\`

### 5.4 主要アルゴリズム

#### 5.4.1 塗りつぶしアルゴリズム（Flood Fill）
\`\`\`javascript
function floodFill(x, y, targetColor, replacementColor) {
  if (targetColor === replacementColor) return;
  if (canvasData[y][x] !== targetColor) return;
  
  const stack = [[x, y]];
  
  while (stack.length > 0) {
    const [cx, cy] = stack.pop();
    
    if (cx < 0 || cx >= 12 || cy < 0 || cy >= 12) continue;
    if (canvasData[cy][cx] !== targetColor) continue;
    
    canvasData[cy][cx] = replacementColor;
    
    // 4方向
    stack.push([cx + 1, cy]);
    stack.push([cx - 1, cy]);
    stack.push([cx, cy + 1]);
    stack.push([cx, cy - 1]);
  }
}
\`\`\`

#### 5.4.2 配列→Canvas変換
\`\`\`javascript
function arrayToCanvas(arr) {
  const imageData = ctx.createImageData(12, 12);
  
  for (let y = 0; y < 12; y++) {
    for (let x = 0; x < 12; x++) {
      const colorIndex = arr[y][x];
      const i = (y * 12 + x) * 4;
      
      if (colorIndex === 0) {
        // 透明
        imageData.data[i] = 0;
        imageData.data[i + 1] = 0;
        imageData.data[i + 2] = 0;
        imageData.data[i + 3] = 0;
      } else {
        // RGB
        const hex = PALETTE[colorIndex].color;
        const rgb = hexToRgb(hex);
        imageData.data[i] = rgb.r;
        imageData.data[i + 1] = rgb.g;
        imageData.data[i + 2] = rgb.b;
        imageData.data[i + 3] = 255;
      }
    }
  }
  
  ctx.putImageData(imageData, 0, 0);
}

function hexToRgb(hex) {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  };
}
\`\`\`

---

## 6. テスト要件

### 6.1 単体テスト項目

| テスト項目 | 確認内容 |
|-----------|---------|
| パレット選択 | 各色を選択し、正しく選択状態になるか |
| ペン描画 | クリック/ドラッグで正しく描画されるか |
| 消しゴム | ピクセルが透明になるか |
| 塗りつぶし | 隣接する同色領域が正しく塗られるか |
| スポイト | 既存ピクセルの色を取得できるか |
| 全消去 | 全ピクセルが透明になるか |
| 配列出力 | 正しい形式で出力されるか |
| 配列読込 | 正しい配列を読み込めるか |
| バリデーション | 不正な配列を拒否するか |

### 6.2 統合テスト項目

| テスト項目 | 確認内容 |
|-----------|---------|
| 描画→出力→読込 | データのround-tripが正しく動作するか |
| 複数ツール切替 | ツール間の切替がスムーズか |
| プレビュー同期 | 描画とプレビューが同期しているか |

### 6.3 ブラウザテスト

| ブラウザ | テスト内容 |
|---------|----------|
| Chrome | 全機能動作確認 |
| Firefox | 全機能動作確認 |
| Safari | 全機能動作確認 |
| Edge | 全機能動作確認 |

---

## 7. 制約事項

### 7.1 技術的制約
- キャンバスサイズは12×12固定（可変不可）
- パレットはDB32固定（カスタムパレット非対応）
- オフライン動作（サーバー通信なし）
- Undo/Redo機能なし
- 自動保存機能なし

### 7.2 機能的制約
- レイヤー機能なし（単一レイヤーのみ）
- アニメーション機能なし
- ファイル保存機能なし（配列コピーのみ）
- 画像エクスポート機能なし（スプライトシートジェネレーターで実施）
- 変形機能なし（反転・回転機能なし）

---

## 8. 納品物

### 8.1 必須ファイル
- \`index.html\` - メインHTML
- \`style.css\` - スタイルシート
- \`script.js\` - JavaScript実装
- \`README.md\` - 使用方法説明

### 8.2 推奨ファイル
- \`palette.js\` - パレット定義（分離推奨）
- \`tools.js\` - ツール実装（分離推奨）

---

## 9. 今後の拡張可能性

### 9.1 優先度高
- [ ] 複数サイズ対応（8×8、16×16、32×32）
- [ ] PNG画像エクスポート機能
- [ ] Undo/Redo機能

### 9.2 優先度中
- [ ] 自動保存機能
- [ ] 変形機能（反転・回転）
- [ ] パレットのカスタマイズ機能

### 9.3 優先度低
- [ ] レイヤー機能
- [ ] アニメーションプレビュー
- [ ] オンライン共有機能

---

## 10. 参考資料

- DB32パレット: https://lospec.com/palette-list/dawnbringer-32
- Canvas API: https://developer.mozilla.org/ja/docs/Web/API/Canvas_API
- Flood Fill Algorithm: https://en.wikipedia.org/wiki/Flood_fill
- Clipboard API: https://developer.mozilla.org/ja/docs/Web/API/Clipboard_API
